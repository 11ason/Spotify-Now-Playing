<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Screensaver</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Titillium Web', sans-serif;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(140px);
        }
        #songInfo {
            text-align: center;
            margin-top: 20px;
            color: white;
            position: relative;
        }
        #albumImage {
            width: 500px;
            height: 500px;
            margin-bottom: 10px;
            border-radius: 15px;
        }
        #info p {
            margin: 3px 0;
        }
        .progress-bar-container {
            margin: 0 auto;
            position: relative;
            width: 400px;
            margin-top: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #bbbbbb77;
            border-radius: 5px;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }
        .progress {
            height: 100%;
            background-color: #00000094;
            width: 0%;
        }
        #time {
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 100%;
            font-size: 12px;
            text-align: center;
            transition: opacity 0.3s ease;
            color: white;
        }
        #elapsed-time {
            position: absolute;
            left: 0;
            bottom: -20px;
            font-size: 12px;
        }
        #total-time {
            position: absolute;
            right: 0;
            bottom: -20px;
            font-size: 12px;
        }
        #toggleButton {
            position: absolute;
            bottom: -40px;
            left: 120px;
            padding: 10px 10px;
            background-color: #ffffff00;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        #songInfo:hover #toggleButton {
            opacity: 1;
        }
    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@700&display=swap">
</head>
<body>
    <div id="songInfo">
        <img id="albumImage" alt="Album Cover">
        <div id="info"></div>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            <p id="time">
                <span id="elapsed-time"></span>
                <span id="total-time"></span>
            </p>
        </div>
        <button id="toggleButton" onclick="toggleVisibility()">Toggle Visibility</button>
    </div>

    <script>
        let previousTime = 0;
        let intervalId;

        function getAccessToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get('access_token');
        }

        function fetchCurrentlyPlayingSong(accessToken) {
            fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('info').innerHTML = '<p>Error: ' + data.error.message + '</p>';
                } else if (data.item) {
                    const songName = data.item.name;
                    const artists = data.item.artists.map(artist => artist.name).join(', ');
                    const albumImage = data.item.album.images[0].url;

                    document.body.style.backgroundImage = `url(${albumImage})`;
                    document.getElementById('albumImage').src = albumImage;

                    const durationMs = data.item.duration_ms;
                    const progressMs = data.progress_ms;

                    document.getElementById('info').innerHTML = `
                        <p>${songName}</p>
                        <p>${artists}</p>
                    `;

                    const progressBar = document.querySelector('.progress');
                    const percentProgress = (progressMs / durationMs) * 100;
                    progressBar.style.width = percentProgress + '%';

                    const currentTime = Date.now();
                    const timeDiff = currentTime - previousTime;
                    previousTime = currentTime;

                    updateTime(timeDiff, progressMs, durationMs);
                } else {
                    document.getElementById('info').innerHTML = '<p>No song is currently playing.</p>';
                }
            })
            .catch(error => {
                document.getElementById('info').innerHTML = '<p>Error: ' + error.message + '</p>';
            });
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function updateTime(timeDiff, progressMs, durationMs) {
            const elapsedTime = progressMs + timeDiff;
            const totalTime = durationMs;

            document.getElementById('elapsed-time').textContent = formatTime(elapsedTime);
            document.getElementById('total-time').textContent = formatTime(totalTime);

            const progressBar = document.querySelector('.progress');
            const percentProgress = (elapsedTime / totalTime) * 100;
            progressBar.style.width = percentProgress + '%';
        }

        function toggleVisibility() {
            const progressBar = document.querySelector('.progress-bar');
            const timeElement = document.getElementById('time');

            if (progressBar.style.opacity === '0') {
                progressBar.style.opacity = '1';
                timeElement.style.opacity = '1';
            } else {
                progressBar.style.opacity = '0';
                timeElement.style.opacity = '0';
            }
        }

        window.onload = function() {
            const accessToken = getAccessToken();
            if (accessToken) {
                fetchCurrentlyPlayingSong(accessToken);
                setInterval(function() {
                    fetchCurrentlyPlayingSong(accessToken);
                }, 1000);
            } else {
                document.getElementById('info').innerHTML = '<p>Error: Access token not found.</p>';
            }
        };
    </script>
</body>
</html>
